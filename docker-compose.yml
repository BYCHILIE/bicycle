services:
  # ==========================================================================
  # JobManager - Control Plane
  # ==========================================================================
  jobmanager:
    build:
      context: .
      target: jobmanager
    container_name: bicycle-jobmanager
    hostname: jobmanager
    ports:
      - "9000:9000"   # Control plane RPC
    environment:
      - RUST_LOG=info,bicycle=debug
      - BICYCLE_STATE_DIR=/var/bicycle/state
      - BICYCLE_CHECKPOINT_DIR=/var/bicycle/checkpoints
    volumes:
      - jobmanager-state:/var/bicycle/state
      - checkpoints:/var/bicycle/checkpoints
    networks:
      - bicycle-net
    healthcheck:
      test: ["CMD", "nc", "-z", "localhost", "9000"]
      interval: 10s
      timeout: 5s
      retries: 3

  # ==========================================================================
  # Workers - Data Plane
  # ==========================================================================
  worker:
    build:
      context: .
      target: worker
    container_name: bicycle-worker
    hostname: worker
    ports:
      - "9001:9001"   # Control plane
      - "9101:9101"   # Data plane
      - "9999:9999"   # Socket job input
      - "9998:9998"   # Socket job output
    environment:
      - RUST_LOG=info,bicycle=debug
    command: ["bin/worker", "--jobmanager", "jobmanager:9000", "--bind", "0.0.0.0:9001", "--data-bind", "0.0.0.0:9101", "--slots", "24", "--memory-mb", "4096"]
    volumes:
      - worker-state:/var/bicycle/state
    networks:
      - bicycle-net
    depends_on:
      - jobmanager

  # ==========================================================================
  # CLI (interactive command-line interface)
  # ==========================================================================
  cli:
    build:
      context: .
      target: cli
    container_name: bicycle-cli
    environment:
      - RUST_LOG=warn
      - BICYCLE_JOBMANAGER=jobmanager:9000
      - KAFKA_BROKERS=kafka:9092
    volumes:
      - ./jobs:/opt/bicycle/jobs:ro
    networks:
      - bicycle-net
    depends_on:
      jobmanager:
        condition: service_healthy
    profiles:
      - cli
    # Usage: docker compose --profile cli run cli <command>
    # Examples:
    #   docker compose --profile cli run cli status
    #   docker compose --profile cli run cli jobs
    #   docker compose --profile cli run cli run jobs/wordcount.yaml
    #   docker compose --profile cli run cli list

  # ==========================================================================
  # Socket Test (for testing socket connectors)
  # ==========================================================================
  socket-test:
    build:
      context: .
      target: socket-test
    container_name: bicycle-socket-test
    ports:
      - "9998:9998"
      - "9999:9999"
    environment:
      - RUST_LOG=info
    networks:
      - bicycle-net
    profiles:
      - test
    # Usage: docker-compose --profile test run socket-test echo
    command: ["echo", "--source-port", "9999", "--sink-port", "9998"]

  # ==========================================================================
  # Standalone Jobs (custom Rust streaming jobs)
  # ==========================================================================
  wordcount:
    image: bicycle-wordcount
    container_name: bicycle-wordcount
    hostname: wordcount
    ports:
      - "7999:9999"   # Job input port
      - "7998:9998"   # Job output port
    environment:
      - RUST_LOG=info
    command: ["--source-port", "9999", "--sink-port", "9998"]
    networks:
      - bicycle-net
    profiles:
      - jobs
    # Usage: docker compose --profile jobs up wordcount
    # Then:  nc localhost 7999 (send input)
    #        nc localhost 7998 (receive output)

  # ==========================================================================
  # Kafka (KRaft mode, no Zookeeper)
  # ==========================================================================
  kafka:
    image: apache/kafka:4.0.0
    container_name: bicycle-kafka
    hostname: kafka
    ports:
      - "9092:9092"
    environment:
      KAFKA_NODE_ID: 1
      KAFKA_PROCESS_ROLES: broker,controller
      KAFKA_CONTROLLER_QUORUM_VOTERS: 1@kafka:9093
      KAFKA_CONTROLLER_LISTENER_NAMES: CONTROLLER
      KAFKA_LISTENERS: PLAINTEXT://0.0.0.0:9092,CONTROLLER://0.0.0.0:9093
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,CONTROLLER:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1
      KAFKA_DEFAULT_REPLICATION_FACTOR: 1
      KAFKA_MIN_INSYNC_REPLICAS: 1
      KAFKA_LOG_DIRS: /var/lib/kafka/data
      CLUSTER_ID: local-dev-kafka-cluster-01
    volumes:
      - kafka-data:/var/lib/kafka/data
    networks:
      - bicycle-net
    profiles:
      - kafka
    healthcheck:
      test: ["CMD-SHELL", "/opt/kafka/bin/kafka-topics.sh --bootstrap-server localhost:9092 --list > /dev/null 2>&1"]
      interval: 10s
      timeout: 10s
      retries: 5
      start_period: 30s

  # ==========================================================================
  # Kafka UI (optional monitoring)
  # ==========================================================================
  kafka-ui:
    image: provectuslabs/kafka-ui:latest
    container_name: bicycle-kafka-ui
    ports:
      - "8085:8080"
    environment:
      KAFKA_CLUSTERS_0_NAME: bicycle
      KAFKA_CLUSTERS_0_BOOTSTRAPSERVERS: kafka:9092
    networks:
      - bicycle-net
    depends_on:
      kafka:
        condition: service_healthy
    profiles:
      - kafka

  # ==========================================================================
  # Word Count Kafka Job (submit to cluster with Kafka pipeline)
  # ==========================================================================
  wordcount-kafka:
    build:
      context: .
      target: wordcount-kafka
    container_name: bicycle-wordcount-kafka
    hostname: wordcount-kafka
    env_file:
      - jobs/wordcount-kafka/.env
    environment:
      - KAFKA_BROKERS=kafka:9092
    networks:
      - bicycle-net
    depends_on:
      kafka:
        condition: service_healthy
      jobmanager:
        condition: service_healthy
    profiles:
      - kafka
    # Usage:
    #   1. Start cluster + kafka: docker compose --profile kafka up -d
    #   2. Create topics:         ./jobs/docker/create_topics.sh kafka:9092
    #   3. Submit the job:
    #      docker compose --profile cli run cli submit bin/wordcount-kafka --plugin lib/libwordcount_kafka.so
    #   4. Send input:            nc localhost 9999
    #   5. Receive output:        nc localhost 9998

  # ==========================================================================
  # API Backend (Rust REST API that talks to JobManager via gRPC)
  # ==========================================================================
  api:
    build:
      context: .
      target: runtime
    container_name: bicycle-api
    hostname: api
    environment:
      - RUST_LOG=info,bicycle=debug
    command: ["bin/webui", "--jobmanager", "jobmanager:9000"]
    networks:
      - bicycle-net
    depends_on:
      - jobmanager

  # ==========================================================================
  # Web UI (Next.js frontend)
  # ==========================================================================
  webui:
    build:
      context: .
      target: webui-next
    container_name: bicycle-webui
    hostname: webui
    ports:
      - "3000:3000"   # Web UI
    environment:
      - NODE_ENV=production
    networks:
      - bicycle-net
    depends_on:
      - api

# ==========================================================================
# Networks
# ==========================================================================
networks:
  bicycle-net:
    driver: bridge

# ==========================================================================
# Volumes
# ==========================================================================
volumes:
  jobmanager-state:
  worker-state:
  checkpoints:
  kafka-data:
