services:
  # ==========================================================================
  # JobManager - Control Plane
  # ==========================================================================
  jobmanager:
    build:
      context: .
      target: jobmanager
    container_name: bicycle-jobmanager
    hostname: jobmanager
    ports:
      - "9000:9000"   # Control plane RPC
    environment:
      - RUST_LOG=info,bicycle=debug
      - BICYCLE_STATE_DIR=/var/bicycle/state
      - BICYCLE_CHECKPOINT_DIR=/var/bicycle/checkpoints
    volumes:
      - jobmanager-state:/var/bicycle/state
      - checkpoints:/var/bicycle/checkpoints
    networks:
      - bicycle-net
    healthcheck:
      test: ["CMD", "nc", "-z", "localhost", "9000"]
      interval: 10s
      timeout: 5s
      retries: 3

  # ==========================================================================
  # Workers - Data Plane
  # ==========================================================================
  worker-1:
    build:
      context: .
      target: worker
    container_name: bicycle-worker-1
    hostname: worker-1
    ports:
      - "9001:9001"
    environment:
      - RUST_LOG=info,bicycle=debug
    command: ["bin/worker", "--jobmanager", "jobmanager:9000", "--bind", "0.0.0.0:9001", "--slots", "4", "--memory-mb", "2048"]
    volumes:
      - worker1-state:/var/bicycle/state
    networks:
      - bicycle-net
    depends_on:
      - jobmanager

  worker-2:
    build:
      context: .
      target: worker
    container_name: bicycle-worker-2
    hostname: worker-2
    ports:
      - "9002:9001"
    environment:
      - RUST_LOG=info,bicycle=debug
    command: ["bin/worker", "--jobmanager", "jobmanager:9000", "--bind", "0.0.0.0:9001", "--slots", "4", "--memory-mb", "2048"]
    volumes:
      - worker2-state:/var/bicycle/state
    networks:
      - bicycle-net
    depends_on:
      - jobmanager

  # ==========================================================================
  # Demo Client (submits jobs to the cluster)
  # ==========================================================================
  demo:
    build:
      context: .
      target: demo
    container_name: bicycle-demo
    command: ["bin/demo-client", "--jobmanager", "jobmanager:9000", "demo", "--duration", "60"]
    environment:
      - RUST_LOG=info,demo_client=debug
    networks:
      - bicycle-net
    depends_on:
      - jobmanager
      - worker-1
      - worker-2
    profiles:
      - demo

  # ==========================================================================
  # Web UI
  # ==========================================================================
  webui:
    build:
      context: .
      target: webui
    container_name: bicycle-webui
    hostname: webui
    ports:
      - "8081:8081"   # Web UI HTTP
    environment:
      - RUST_LOG=info,bicycle=debug
    command: ["bin/webui", "--bind", "0.0.0.0:8081", "--jobmanager", "jobmanager:9000"]
    networks:
      - bicycle-net
    depends_on:
      - jobmanager

# ==========================================================================
# Networks
# ==========================================================================
networks:
  bicycle-net:
    driver: bridge

# ==========================================================================
# Volumes
# ==========================================================================
volumes:
  jobmanager-state:
  worker1-state:
  worker2-state:
  checkpoints:
